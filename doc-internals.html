<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Embedded Dependencies" />

    <title>Internals
</title>

    
    <link rel="stylesheet" href="styles.css" />
    
  </head>

  <body class="body--themed">
    <div id="__app__"><div data-reactroot="" data-reactid="1" data-react-checksum="-821705374"><div data-reactid="2"></div><!-- react-empty: 3 --><!-- react-empty: 4 --><div class="root root--with-multi-page-layout root--with-fixed-sidebar root--with-two-column-layout root--without-banner" data-reactid="5"><div class="root__screen" data-reactid="6"><div class="two-column-layout two-column-layout--with-nav" data-reactid="7"><div class="two-column-layout__left" style="width:240px;" data-reactid="8"><div class="resizable-panel" data-reactid="9"><div class="resizable-panel__content" data-reactid="10"><div data-reactid="11"><div data-reactid="12"><nav data-reactid="13"><div data-reactid="14"><div data-reactid="15"><a href="index.html" class="class-browser__entry-link" data-reactid="16"><!-- react-text: 17 -->Karazeh
<!-- /react-text --></a></div><div data-reactid="18"><a href="doc-architecture.html" class="class-browser__entry-link" data-reactid="19"><!-- react-text: 20 -->Architecture
<!-- /react-text --></a></div><div data-reactid="21"><a href="doc-faq.html" class="class-browser__entry-link" data-reactid="22"><!-- react-text: 23 -->FAQ
<!-- /react-text --></a></div><div data-reactid="24"><a href="" class="class-browser__entry-link active" data-reactid="25"><!-- react-text: 26 -->Internals
<!-- /react-text --></a></div><div data-reactid="27"><a href="doc-overview.html" class="class-browser__entry-link" data-reactid="28"><!-- react-text: 29 -->Overview
<!-- /react-text --></a></div></div></nav></div></div></div><div class="ui-resizable-handle ui-resizable-e" data-reactid="30"></div></div></div><div class="two-column-layout__right" style="margin-left:240px;" data-reactid="31"><div data-reactid="32"><div class="doc-content" data-reactid="33"><div data-reactid="34"><div data-reactid="35"><div class="highlighted-text " data-reactid="36">
    <h1 class="anchorable-heading">
      <a name="internals" class="anchorable-heading__anchor"></a>
      <a href="#internals" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Internals</span>
    </h1>
  
    <h2 class="anchorable-heading">
      <a name="current-dependencies" class="anchorable-heading__anchor"></a>
      <a href="#current-dependencies" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Current dependencies</span>
    </h2>
  <ul>
<li><a href="http://boost.org" target="_blank">boost 1.46+</a> for the <code>filesystem</code> library</li>
<li><a href="http://curl.haxx.se" target="_blank">cURL</a></li>
<li><a href="http://cmake.org" target="_blank">CMake 2.8+</a> for building</li>
</ul>
<p><strong>Embedded Dependencies</strong></p>
<ul>
<li><a href="http://librsync.sourceforge.net" target="_blank">librsync</a></li>
<li><a href="http://www.grinninglizard.com/tinyxml2/index.html" target="_blank">tinyxml2</a></li>
<li><a href="http://pawnscript.googlecode.com/svn-history/r6/trunk/linux/binreloc.c" target="_blank">binreloc</a> <em>Linux only</em></li>
<li>md5</li>
</ul>

    <h2 class="anchorable-heading">
      <a name="identifying-the-application-version" class="anchorable-heading__anchor"></a>
      <a href="#identifying-the-application-version" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Identifying the application version</span>
    </h2>
  <p>Karazeh tells which version of the application the user is currently running by way of calculating checksums of a number of files referred to as the <strong>identity files</strong>. Those checksums are joined together and the resulting &quot;blob&quot; is finally digested into another checksum known as the <strong>identity checksum</strong>. The identity checksum is, to Karazeh, the version of the running application.</p>
<p>Identity files could be a singular binary file (the application&#39;s executable, for example), or a list of files; maybe the executable joined with the core data archive, or a crtiical script component. The usage of identity files guarantees that should any of them be tampered with, the identity checksum will no longer match the expected one resulting in an unidentified version, or a <em>corrupt</em> one.</p>
<p>Finally, each release can define its own list of identity files. For example, a game might use its binary as the identity file until its expansion comes out where another binary is introduced, so the expansion releases can define both binaries to be the identity files.</p>

    <h2 class="anchorable-heading">
      <a name="versioning-schemes" class="anchorable-heading__anchor"></a>
      <a href="#versioning-schemes" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Versioning schemes</span>
    </h2>
  <p>Thanks to using identity files for identifying the version of the application, Karazeh does not force you to any particular versioning scheme. In fact, a &quot;version&quot;, or <em>tag</em> as it is referred to internally, is really nothing but a string to it that has no meaning. The tag can be used by you, the application developer, to label your versions in a way <strong>you</strong> see fit. The tag is also what&#39;s commonly displayed to the user, since it&#39;s much more friendly than a hex digest (the identity checksum).</p>
<p>Examples of some popular versioning schemes: <code>1.0.3-rc1</code>, <code>10.6</code>, <code>b01cd.0</code>, <code>10.7 Lion</code>, etc.</p>
<p>Notice how you can also use &quot;codenames&quot; as well as numbered schemes; define the tag you way you want, and parse it the way you want, Karazeh will not interfere.</p>

    <h2 class="anchorable-heading">
      <a name="generating-binary-diffs" class="anchorable-heading__anchor"></a>
      <a href="#generating-binary-diffs" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Generating binary diffs</span>
    </h2>
  <p>Binary files and data archives are usually very large, and it&#39;s inefficient to force the user to re-download them everytime they&#39;re updated. Karazeh can help you transmit only the parts that change - to an extent - in those binary files via a <a href="http://en.wikipedia.org/wiki/Delta_encoding" target="_blank">delta encoding</a> solution, <a href="librsync.sourceforge.net" target="_blank"><code>librsync</code></a>.</p>

    <h3 class="anchorable-heading">
      <a name="the-hunt-for-a-delta-encoding-solution" class="anchorable-heading__anchor"></a>
      <a href="#the-hunt-for-a-delta-encoding-solution" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">The hunt for a delta encoding solution</span>
    </h3>
  <p>The difficulty lied in the number of requirements the library had to meet for it to be usable in Karazeh:</p>
<ol>
<li>memory efficiency in both encoding and decoding routines</li>
<li>licensing compatibility (not proprietary, nor GPL)</li>
<li>support for processing large enough basis files that can acommodate today&#39;s binary file requirements (some games have data archives as large as 20GBytes)</li>
<li>delta filesize efficiency</li>
<li>cross-platform operabiliity</li>
</ol>
<p>So in my hunt for a solution, I came accross the following:</p>
<ol>
<li><a href="http://www.daemonology.net/bsdiff/" target="_blank"><code>bsdiff</code></a> - unforgivably fast and efficient, but just as much memory-hungry; it didn&#39;t satisfy requirement#1</li>
<li><a href="http://xdelta.org" target="_blank"><code>xdelta3</code></a> - the most memory efficient solution I&#39;ve tried, and the fastest, with a bit higher patch file sizes but that&#39;s a trivial price to its speed - but it&#39;s GPL licensed</li>
<li><a href="http://code.google.com/p/open-vcdiff/" target="_blank"><code>open-vcdiff</code></a> - maybe I didn&#39;t know how to use it, but it ate all my memory while patching a 1GByte archive just like <code>bsdiff</code> did</li>
</ol>
<p>Finally, I met <code>rdiff</code>/<code>librsync</code> and it won on all grounds; license compatibility, memory requirements, speed, and patch filesize.</p>

    <h2 class="anchorable-heading">
      <a name="operations" class="anchorable-heading__anchor"></a>
      <a href="#operations" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Operations</span>
    </h2>
  <p>The following breakdown satisfies the operation requirements: Creation, Renaming, Updating, and Deletion of files (or directories, when applicable.)</p>

    <h3 class="anchorable-heading">
      <a name="create" class="anchorable-heading__anchor"></a>
      <a href="#create" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text"><code>create</code></span>
    </h3>
  <p>Arguments:</p>
<ol>
<li>the source file: this is the file that will be fetched from the server and &quot;copied&quot; to a final destination</li>
<li>the destination: the fully qualified path the file should be placed at when the patch is committed</li>
</ol>
<p><strong>Staging</strong></p>
<ol>
<li>verify that no file exists at the destination</li>
<li>verify that the running user has write permissions</li>
<li>verify that there&#39;s enough space to hold the file</li>
<li>fetch the file and store it in the staging reposistory</li>
<li>validate the file&#39;s integrity, and redownload if necessary</li>
</ol>
<p><strong>Deployment</strong></p>
<ol>
<li>move the file from the staged source to the destination</li>
</ol>
<p><code>create</code> in the release manifest:</p>
<pre class="language-xml"><code><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>create</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>source</span> <span class="token attr-name" >checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>1234<span class="token punctuation" >"</span></span> <span class="token attr-name" >size</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>500<span class="token punctuation" >"</span></span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/source]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>source</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>destination</span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/destination]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>destination</span><span class="token punctuation" >></span></span>
<span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>create</span><span class="token punctuation" >></span></span></code></pre><hr>

    <h3 class="anchorable-heading">
      <a name="update" class="anchorable-heading__anchor"></a>
      <a href="#update" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text"><code>update</code></span>
    </h3>
  <p>Arguments:</p>
<ol>
<li>the source file; the file to be patched</li>
<li>the source file&#39;s checksum</li>
<li>the patch file</li>
<li>the patch file&#39;s checksum</li>
<li>the patch file&#39;s size</li>
</ol>
<p><strong>Staging</strong></p>
<ol>
<li>verify that the source exists</li>
<li>validate the integrity of the source</li>
<li>verify that there&#39;s enough space to hold the patch file
<strong>and</strong> the backup of the source file</li>
<li>fetch the patch file</li>
<li>validate the integrity of the patch file</li>
<li>create a backup of the source file</li>
</ol>
<p><strong>Deployment</strong></p>
<ol>
<li>apply the patch on the clone (aka backup)</li>
<li>validate the integrity of the patched file:<ol>
<li>if the integrity test fails, announce a rollback</li>
</ol>
</li>
<li>remove the source file</li>
<li>move the patched file to the source&#39;s destination</li>
</ol>
<p><code>create</code> in the release manifest:</p>
<pre class="language-xml"><code><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>update</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>target</span> <span class="token attr-name" >pre-checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>1234<span class="token punctuation" >"</span></span> <span class="token attr-name" >post-checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>5678<span class="token punctuation" >"</span></span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/file]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>target</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>patch</span>  <span class="token attr-name" >checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>5678<span class="token punctuation" >"</span></span> <span class="token attr-name" >size</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>100<span class="token punctuation" >"</span></span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/patch]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>patch</span><span class="token punctuation" >></span></span>
<span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>update</span><span class="token punctuation" >></span></span></code></pre><hr>

    <h3 class="anchorable-heading">
      <a name="rename" class="anchorable-heading__anchor"></a>
      <a href="#rename" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text"><code>rename</code></span>
    </h3>
  <p>Arguments:</p>
<ol>
<li>the fully qualified source path</li>
<li>the fully qualified destination path</li>
</ol>
<p><strong>Staging</strong></p>
<ol>
<li>verify that the source exists</li>
<li>verify that the destination is clear</li>
</ol>
<p><strong>Deployment</strong></p>
<ol>
<li>move the source to the destination</li>
</ol>
<p><code>rename</code> in the release manifest:</p>
<pre class="language-xml"><code><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>rename</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>from</span> <span class="token attr-name" >checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>[1234]<span class="token punctuation" >"</span></span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/file]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>from</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>to</span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/new/path/to/file]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>to</span><span class="token punctuation" >></span></span>
<span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>rename</span><span class="token punctuation" >></span></span></code></pre><hr>

    <h3 class="anchorable-heading">
      <a name="delete" class="anchorable-heading__anchor"></a>
      <a href="#delete" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text"><code>delete</code></span>
    </h3>
  <p>Arguments:</p>
<ol>
<li>the fully qualified source path</li>
</ol>
<p><strong>Staging</strong></p>
<ol>
<li>verify that the source exists</li>
</ol>
<p><strong>Deployment</strong></p>
<ol>
<li>if the source is a directory, recursively empty its contents</li>
<li>remove the source</li>
</ol>
<p><code>delete</code> in the release manifest:</p>
<pre class="language-xml"><code><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>delete</span><span class="token punctuation" >></span></span>
  <span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;</span>target</span> <span class="token attr-name" >checksum</span><span class="token attr-value" ><span class="token punctuation" >=</span><span class="token punctuation" >"</span>[1234]<span class="token punctuation" >"</span></span><span class="token punctuation" >></span></span><span class="token cdata" >&lt;![CDATA[/path/to/file-or-directory]]></span><span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>target</span><span class="token punctuation" >></span></span>
<span class="token tag" ><span class="token tag" ><span class="token punctuation" >&lt;/</span>delete</span><span class="token punctuation" >></span></span></code></pre>
    <h3 class="anchorable-heading">
      <a name="notes" class="anchorable-heading__anchor"></a>
      <a href="#notes" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Notes</span>
    </h3>
  <ul>
<li><code>&lt;create executable=&quot;true&quot;&gt;</code> will cause the patcher to mark the created file as executable (chmod 0711)</li>
<li><code>&lt;delete&gt;</code> entries will internally mark those paths as &quot;to be deleted&quot;, so any subsequent  <code>&lt;create&gt;</code> entry with one of those paths will know that they will be deleted, and will not cause a staging error; effectively, we achieve the effect of <code>&lt;replace&gt;</code> without having to implement any!</li>
<li>running with <code>-v</code> will cause the <code>resource_manager</code> to print out the content of all downloaded files</li>
<li><code>&lt;delete&gt;</code> recursively removes directories as well as files</li>
</ul>

    <h2 class="anchorable-heading">
      <a name="the-version-manifest" class="anchorable-heading__anchor"></a>
      <a href="#the-version-manifest" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">The Version Manifest</span>
    </h2>
  <pre class="language-xml"><code>[!include!](https://raw.github.com/amireh/karazeh_v2/master/doc/version_manifest.template.xml)</code></pre>
    <h2 class="anchorable-heading">
      <a name="the-release-manifest" class="anchorable-heading__anchor"></a>
      <a href="#the-release-manifest" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">The Release Manifest</span>
    </h2>
  <pre class="language-xml"><code>[!include!](https://raw.github.com/amireh/karazeh_v2/master/doc/release_manifest.template.xml)</code></pre></div><!-- react-empty: 37 --></div></div></div><div class="footer" data-reactid="38"><div class="markdown-text " data-reactid="39"><p>Made with &#9829; using <a href="https://github.com/megadoc" target="_blank">megadoc</a>.</p>
</div></div></div></div><div class="two-column-layout__nav" data-reactid="40"><div class="sticky-container" data-reactid="41"><div class="doc-content" data-reactid="42"><p data-reactid="43">Contents</p><div data-reactid="44"><div data-reactid="45"><ul class="markdown-toc markdown-toc--flat" data-reactid="46"><li class="markdown-toc__entry" data-reactid="47"><a href="#current-dependencies" class="" data-reactid="48">Current dependencies</a></li><li class="markdown-toc__entry" data-reactid="49"><a href="#identifying-the-application-version" class="" data-reactid="50">Identifying the application version</a></li><li class="markdown-toc__entry" data-reactid="51"><a href="#versioning-schemes" class="" data-reactid="52">Versioning schemes</a></li><li class="markdown-toc__entry markdown-toc__entry--collapsible" data-reactid="53"><i class="icon icon-arrow-right" data-reactid="54"></i><a href="#generating-binary-diffs" class="" data-reactid="55">Generating binary diffs</a><ul class="markdown-toc" data-reactid="56"><li class="markdown-toc__entry" data-reactid="57"><a href="#the-hunt-for-a-delta-encoding-solution" class="" data-reactid="58">The hunt for a delta encoding solution</a></li></ul></li><li class="markdown-toc__entry markdown-toc__entry--collapsible" data-reactid="59"><i class="icon icon-arrow-right" data-reactid="60"></i><a href="#operations" class="" data-reactid="61">Operations</a><ul class="markdown-toc" data-reactid="62"><li class="markdown-toc__entry" data-reactid="63"><a href="#create" class="" data-reactid="64">create</a></li><li class="markdown-toc__entry" data-reactid="65"><a href="#update" class="" data-reactid="66">update</a></li><li class="markdown-toc__entry" data-reactid="67"><a href="#rename" class="" data-reactid="68">rename</a></li><li class="markdown-toc__entry" data-reactid="69"><a href="#delete" class="" data-reactid="70">delete</a></li><li class="markdown-toc__entry" data-reactid="71"><a href="#notes" class="" data-reactid="72">Notes</a></li></ul></li><li class="markdown-toc__entry" data-reactid="73"><a href="#the-version-manifest" class="" data-reactid="74">The Version Manifest</a></li><li class="markdown-toc__entry" data-reactid="75"><a href="#the-release-manifest" class="" data-reactid="76">The Release Manifest</a></li></ul></div></div></div></div></div></div></div></div></div></div>
    
    <script type="text/javascript" src="config.js"></script>
    
    <script type="text/javascript" src="megadoc__vendor.js"></script>
    
    <script type="text/javascript" src="megadoc.js"></script>
    
    <script type="text/javascript" src="plugins/megadoc-theme-qt.js"></script>
    
    <script type="text/javascript" src="plugins/megadoc-plugin-markdown.js"></script>
    
    <script type="text/javascript">
      megadoc.start({
        startingDocumentUID: "articles/doc-internals"
      });
    </script>
  </body>
</html>
