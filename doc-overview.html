<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="The main reason I decided to rebuild Karazeh from the grounds up is to redesign the main patching process in order to obtain a reasonable amount of robustness. I don&#39;t want it to be responsible for corrupting an application repository, and so I&#39;ve decided to break down the process of applying a patch into four phases: two of them are sequential, and two are conditional." />

    <title>Overview
</title>

    
    <link rel="stylesheet" href="styles.css" />
    
  </head>

  <body class="body--themed">
    <div id="__app__"><div data-reactroot="" data-reactid="1" data-react-checksum="-578110988"><div data-reactid="2"></div><!-- react-empty: 3 --><!-- react-empty: 4 --><div class="root root--with-multi-page-layout root--with-fixed-sidebar root--with-two-column-layout root--without-banner" data-reactid="5"><div class="root__screen" data-reactid="6"><div class="two-column-layout two-column-layout--with-nav" data-reactid="7"><div class="two-column-layout__left" style="width:240px;" data-reactid="8"><div class="resizable-panel" data-reactid="9"><div class="resizable-panel__content" data-reactid="10"><div data-reactid="11"><div data-reactid="12"><nav data-reactid="13"><div data-reactid="14"><div data-reactid="15"><a href="index.html" class="class-browser__entry-link" data-reactid="16"><!-- react-text: 17 -->Karazeh
<!-- /react-text --></a></div><div data-reactid="18"><a href="doc-architecture.html" class="class-browser__entry-link" data-reactid="19"><!-- react-text: 20 -->Architecture
<!-- /react-text --></a></div><div data-reactid="21"><a href="doc-faq.html" class="class-browser__entry-link" data-reactid="22"><!-- react-text: 23 -->FAQ
<!-- /react-text --></a></div><div data-reactid="24"><a href="doc-internals.html" class="class-browser__entry-link" data-reactid="25"><!-- react-text: 26 -->Internals
<!-- /react-text --></a></div><div data-reactid="27"><a href="" class="class-browser__entry-link active" data-reactid="28"><!-- react-text: 29 -->Overview
<!-- /react-text --></a></div></div></nav></div></div></div><div class="ui-resizable-handle ui-resizable-e" data-reactid="30"></div></div></div><div class="two-column-layout__right" style="margin-left:240px;" data-reactid="31"><div data-reactid="32"><div class="doc-content" data-reactid="33"><div data-reactid="34"><div data-reactid="35"><div class="highlighted-text " data-reactid="36">
    <h1 class="anchorable-heading">
      <a name="overview" class="anchorable-heading__anchor"></a>
      <a href="#overview" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Overview</span>
    </h1>
  <p>The main reason I decided to rebuild Karazeh from the grounds up is to redesign the main patching process in order to obtain a reasonable amount of <strong>robustness</strong>. I don&#39;t want it to be responsible for <em>corrupting</em> an application repository, and so I&#39;ve decided to break down the process of applying a patch into four phases: two of them are sequential, and two are conditional.</p>
<p>Each operation has its own routine for each phase.</p>
<iframe
  id="xmindshare_embedviewer"
  src="http://www.xmind.net/embed/FFcq?size=large"
  width="100%"
  height="540px"
  frameborder="0"
  scrolling="no"
></iframe>

<p>The map lists every action and test done by each operation during each phase of applying a patch. The stages are explained in the following sections.</p>

    <h2 class="anchorable-heading">
      <a name="phase-1-staging" class="anchorable-heading__anchor"></a>
      <a href="#phase-1-staging" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Phase 1 - Staging</span>
    </h2>
  <p>The first stage of applying a patch is aptly named <em>staging</em> and it is a stage of aggressive checks and verifications that tries to ensure that nothing will go wrong when Karazeh will start modifying things.</p>
<p>Operations that require downloading remote resources, such as <code>create</code> and <code>update</code>, do so during the staging process. The downloaded files are kept in the cache. They will also validate the integrity of the downloaded files.</p>
<p>The diagram above explains in detail what each operation does in each stage; the checks and actions it takes.</p>
<p><strong>During staging and deployment, any operation that fails for any reason will cause the patcher to invoke a rollback, effectively restoring the application to its earlier state.</strong></p>

    <h2 class="anchorable-heading">
      <a name="phase-2-deployment" class="anchorable-heading__anchor"></a>
      <a href="#phase-2-deployment" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Phase 2 - Deployment</span>
    </h2>
  <p>Alright, so now we have our patch files ready, and we&#39;ve done the required testing. Well, something might have changed since the operations were staged, so <strong>some</strong> of the tests are re-run before deployment.</p>
<p>Deployment is where application files are actually modified. <code>create</code> operation now actually creates the new resource at its specified destination, the <code>update</code> operation performs the patching on the target file, <code>delete</code> removes the file (almost true), etc.</p>
<p>As noted in the Staging section, any failure here will also cause a rollback. But the question is, how can we rollback if we&#39;ve modified files or removed them? Even in the deployment stage (and the staging one), no operation modifies an application file in any way without either:</p>
<ol>
<li>making a backup</li>
<li>making sure there&#39;s a way to revert the file to its original state</li>
</ol>
<p>So in the case of <code>delete</code>, all it truly does in the deployment stage is <em>move</em> the file from its original location into the <em>cache</em>. So if a rollback is invoked, it&#39;s simply a matter of moving the file back from the cache to its original location.</p>
<p>If everything went okay with staging and deployment, the committing stage is entered.</p>

    <h2 class="anchorable-heading">
      <a name="rolling-back" class="anchorable-heading__anchor"></a>
      <a href="#rolling-back" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Rolling Back</span>
    </h2>
  <p>The only thing worth noting here is that any failure reached while rolling back the changes will most definitely cause a <strong>version corruption</strong>. So far, I haven&#39;t thought out a solution to <em>repair</em> corrupt versions so I have little to say here.</p>
<p>Rollback routines are meant to undo any changes made while staging and deploying.</p>

    <h2 class="anchorable-heading">
      <a name="committing" class="anchorable-heading__anchor"></a>
      <a href="#committing" class="anchorable-heading__link icon icon-link"></a><span class="anchorable-heading__text">Committing</span>
    </h2>
  <p>If everything went OK and no rollback was invoked, all operations are called to &quot;commit&quot; their changes; a commit means that the patch was applied successfully, and any <em>transient</em> data maintained for rolling-back can be safely discarded.</p>
<p>In the case of <code>delete</code>, this means it will remove the file from the cache. <code>update</code> will delete the patch file and the backup, etc. The cache should be effectively purged after this stage, and there will be nothing more to do!</p>
</div><!-- react-empty: 37 --></div></div></div><div class="footer" data-reactid="38"><div class="markdown-text " data-reactid="39"><p>Made with &#9829; using <a href="https://github.com/megadoc" target="_blank">megadoc</a>.</p>
</div></div></div></div><div class="two-column-layout__nav" data-reactid="40"><div class="sticky-container" data-reactid="41"><div class="doc-content" data-reactid="42"><p data-reactid="43">Contents</p><div data-reactid="44"><div data-reactid="45"><ul class="markdown-toc markdown-toc--flat" data-reactid="46"><li class="markdown-toc__entry" data-reactid="47"><a href="#phase-1-staging" class="" data-reactid="48">Phase 1 - Staging</a></li><li class="markdown-toc__entry" data-reactid="49"><a href="#phase-2-deployment" class="" data-reactid="50">Phase 2 - Deployment</a></li><li class="markdown-toc__entry" data-reactid="51"><a href="#rolling-back" class="" data-reactid="52">Rolling Back</a></li><li class="markdown-toc__entry" data-reactid="53"><a href="#committing" class="" data-reactid="54">Committing</a></li></ul></div></div></div></div></div></div></div></div></div></div>
    
    <script type="text/javascript" src="config.js"></script>
    
    <script type="text/javascript" src="megadoc__vendor.js"></script>
    
    <script type="text/javascript" src="megadoc.js"></script>
    
    <script type="text/javascript" src="plugins/megadoc-theme-qt.js"></script>
    
    <script type="text/javascript" src="plugins/megadoc-plugin-markdown.js"></script>
    
    <script type="text/javascript">
      megadoc.start({
        startingDocumentUID: "articles/doc-overview"
      });
    </script>
  </body>
</html>
